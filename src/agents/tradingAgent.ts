/**
 * open-nof1.ai - AI åŠ å¯†è´§å¸è‡ªåŠ¨äº¤æ˜“ç³»ç»Ÿ
 * Copyright (C) 2025 195440
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */

/**
 * äº¤æ˜“ Agent é…ç½®ï¼ˆæç®€ç‰ˆï¼‰
 */
import { Agent, Memory } from "@voltagent/core";
import { LibSQLMemoryAdapter } from "@voltagent/libsql";
import { createPinoLogger } from "@voltagent/logger";
import { createOpenRouter } from "@openrouter/ai-sdk-provider";
import * as tradingTools from "../tools/trading";
import { formatChinaTime } from "../utils/timeUtils";
import { RISK_PARAMS } from "../config/riskParams";

/**
 * è´¦æˆ·é£é™©é…ç½®
 */
export interface AccountRiskConfig {
  stopLossUsdt: number;
  takeProfitUsdt: number;
  syncOnStartup: boolean;
}

/**
 * ä»ç¯å¢ƒå˜é‡è¯»å–è´¦æˆ·é£é™©é…ç½®
 */
export function getAccountRiskConfig(): AccountRiskConfig {
  return {
    stopLossUsdt: Number.parseFloat(process.env.ACCOUNT_STOP_LOSS_USDT || "50"),
    takeProfitUsdt: Number.parseFloat(process.env.ACCOUNT_TAKE_PROFIT_USDT || "10000"),
    syncOnStartup: process.env.SYNC_CONFIG_ON_STARTUP === "true",
  };
}

const logger = createPinoLogger({
  name: "trading-agent",
  level: "info",
});

/**
 * ç”Ÿæˆäº¤æ˜“æç¤ºè¯ï¼ˆå‚ç…§ 1.md æ ¼å¼ï¼‰
 */
export function generateTradingPrompt(data: {
  minutesElapsed: number;
  iteration: number;
  marketData: any;
  accountInfo: any;
  positions: any[];
  tradeHistory?: any[];
  recentDecisions?: any[];
}): string {
  const { minutesElapsed, iteration, marketData, accountInfo, positions, tradeHistory, recentDecisions } = data;
  const currentTime = formatChinaTime();
  
  let prompt = `æ‚¨å·²ç»å¼€å§‹äº¤æ˜“ ${minutesElapsed} åˆ†é’Ÿã€‚å½“å‰æ—¶é—´æ˜¯ ${currentTime}ï¼Œæ‚¨å·²è¢«è°ƒç”¨ ${iteration} æ¬¡ã€‚ä¸‹é¢æˆ‘ä»¬ä¸ºæ‚¨æä¾›å„ç§çŠ¶æ€æ•°æ®ã€ä»·æ ¼æ•°æ®å’Œé¢„æµ‹ä¿¡å·ï¼Œä»¥ä¾¿æ‚¨å‘ç°é˜¿å°”æ³•æ”¶ç›Šã€‚ä¸‹é¢è¿˜æœ‰æ‚¨å½“å‰çš„è´¦æˆ·ä¿¡æ¯ã€ä»·å€¼ã€è¡¨ç°ã€æŒä»“ç­‰ã€‚

ä»¥ä¸‹æ‰€æœ‰ä»·æ ¼æˆ–ä¿¡å·æ•°æ®æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼šæœ€æ—§ â†’ æœ€æ–°

æ—¶é—´æ¡†æ¶è¯´æ˜ï¼šé™¤éåœ¨ç« èŠ‚æ ‡é¢˜ä¸­å¦æœ‰è¯´æ˜ï¼Œå¦åˆ™æ—¥å†…åºåˆ—ä»¥ 3 åˆ†é’Ÿé—´éš”æä¾›ã€‚å¦‚æœæŸä¸ªå¸ç§ä½¿ç”¨ä¸åŒçš„é—´éš”ï¼Œå°†åœ¨è¯¥å¸ç§çš„ç« èŠ‚ä¸­æ˜ç¡®è¯´æ˜ã€‚

æ‰€æœ‰å¸ç§çš„å½“å‰å¸‚åœºçŠ¶æ€
`;

  // æŒ‰ç…§ 1.md æ ¼å¼è¾“å‡ºæ¯ä¸ªå¸ç§çš„æ•°æ®
  for (const [symbol, dataRaw] of Object.entries(marketData)) {
    const data = dataRaw as any;
    
    prompt += `\næ‰€æœ‰ ${symbol} æ•°æ®\n`;
    prompt += `å½“å‰ä»·æ ¼ = ${data.price.toFixed(1)}, å½“å‰EMA20 = ${data.ema20.toFixed(3)}, å½“å‰MACD = ${data.macd.toFixed(3)}, å½“å‰RSIï¼ˆ7å‘¨æœŸï¼‰ = ${data.rsi7.toFixed(3)}\n\n`;
    
    // èµ„é‡‘è´¹ç‡
    if (data.fundingRate !== undefined) {
      prompt += `æ­¤å¤–ï¼Œè¿™æ˜¯ ${symbol} æ°¸ç»­åˆçº¦çš„æœ€æ–°èµ„é‡‘è´¹ç‡ï¼ˆæ‚¨äº¤æ˜“çš„åˆçº¦ç±»å‹ï¼‰ï¼š\n\n`;
      prompt += `èµ„é‡‘è´¹ç‡: ${data.fundingRate.toExponential(2)}\n\n`;
    }
    
    // æ—¥å†…æ—¶åºæ•°æ®ï¼ˆ3åˆ†é’Ÿçº§åˆ«ï¼‰
    if (data.intradaySeries && data.intradaySeries.midPrices.length > 0) {
      const series = data.intradaySeries;
      prompt += `æ—¥å†…åºåˆ—ï¼ˆæŒ‰åˆ†é’Ÿï¼Œæœ€æ—§ â†’ æœ€æ–°ï¼‰ï¼š\n\n`;
      
      // Mid prices
      prompt += `ä¸­é—´ä»·: [${series.midPrices.map((p: number) => p.toFixed(1)).join(", ")}]\n\n`;
      
      // EMA indicators (20â€‘period)
      prompt += `EMAæŒ‡æ ‡ï¼ˆ20å‘¨æœŸï¼‰: [${series.ema20Series.map((e: number) => e.toFixed(3)).join(", ")}]\n\n`;
      
      // MACD indicators
      prompt += `MACDæŒ‡æ ‡: [${series.macdSeries.map((m: number) => m.toFixed(3)).join(", ")}]\n\n`;
      
      // RSI indicators (7â€‘Period)
      prompt += `RSIæŒ‡æ ‡ï¼ˆ7å‘¨æœŸï¼‰: [${series.rsi7Series.map((r: number) => r.toFixed(3)).join(", ")}]\n\n`;
      
      // RSI indicators (14â€‘Period)
      prompt += `RSIæŒ‡æ ‡ï¼ˆ14å‘¨æœŸï¼‰: [${series.rsi14Series.map((r: number) => r.toFixed(3)).join(", ")}]\n\n`;
    }
    
    // æ›´é•¿æœŸçš„ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆ1å°æ—¶çº§åˆ« - ç”¨äºçŸ­çº¿äº¤æ˜“ï¼‰
    if (data.longerTermContext) {
      const ltc = data.longerTermContext;
      prompt += `æ›´é•¿æœŸä¸Šä¸‹æ–‡ï¼ˆ1å°æ—¶æ—¶é—´æ¡†æ¶ï¼‰ï¼š\n\n`;
      
      prompt += `20å‘¨æœŸEMA: ${ltc.ema20.toFixed(2)} vs. 50å‘¨æœŸEMA: ${ltc.ema50.toFixed(2)}\n\n`;
      
      if (ltc.atr3 && ltc.atr14) {
        prompt += `3å‘¨æœŸATR: ${ltc.atr3.toFixed(2)} vs. 14å‘¨æœŸATR: ${ltc.atr14.toFixed(3)}\n\n`;
      }
      
      prompt += `å½“å‰æˆäº¤é‡: ${ltc.currentVolume.toFixed(2)} vs. å¹³å‡æˆäº¤é‡: ${ltc.avgVolume.toFixed(3)}\n\n`;
      
      // MACD å’Œ RSI æ—¶åºï¼ˆ4å°æ—¶ï¼Œæœ€è¿‘10ä¸ªæ•°æ®ç‚¹ï¼‰
      if (ltc.macdSeries && ltc.macdSeries.length > 0) {
        prompt += `MACDæŒ‡æ ‡: [${ltc.macdSeries.map((m: number) => m.toFixed(3)).join(", ")}]\n\n`;
      }
      
      if (ltc.rsi14Series && ltc.rsi14Series.length > 0) {
        prompt += `RSIæŒ‡æ ‡ï¼ˆ14å‘¨æœŸï¼‰: [${ltc.rsi14Series.map((r: number) => r.toFixed(3)).join(", ")}]\n\n`;
      }
    }
    
    // å¤šæ—¶é—´æ¡†æ¶æŒ‡æ ‡æ•°æ®
    if (data.timeframes) {
      prompt += `å¤šæ—¶é—´æ¡†æ¶æŒ‡æ ‡ï¼š\n\n`;
      
      const tfList = [
        { key: "1m", name: "1åˆ†é’Ÿ" },
        { key: "3m", name: "3åˆ†é’Ÿ" },
        { key: "5m", name: "5åˆ†é’Ÿ" },
        { key: "15m", name: "15åˆ†é’Ÿ" },
        { key: "30m", name: "30åˆ†é’Ÿ" },
        { key: "1h", name: "1å°æ—¶" },
      ];
      
      for (const tf of tfList) {
        const tfData = data.timeframes[tf.key];
        if (tfData) {
          prompt += `${tf.name}: ä»·æ ¼=${tfData.currentPrice.toFixed(2)}, EMA20=${tfData.ema20.toFixed(3)}, EMA50=${tfData.ema50.toFixed(3)}, MACD=${tfData.macd.toFixed(3)}, RSI7=${tfData.rsi7.toFixed(2)}, RSI14=${tfData.rsi14.toFixed(2)}, æˆäº¤é‡=${tfData.volume.toFixed(2)}\n`;
        }
      }
      prompt += `\n`;
    }
  }

  // è´¦æˆ·ä¿¡æ¯å’Œè¡¨ç°ï¼ˆå‚ç…§ 1.md æ ¼å¼ï¼‰
  prompt += `\nä»¥ä¸‹æ˜¯æ‚¨çš„è´¦æˆ·ä¿¡æ¯å’Œè¡¨ç°\n`;
  
  // è®¡ç®—è´¦æˆ·å›æ’¤ï¼ˆå¦‚æœæä¾›äº†åˆå§‹å‡€å€¼å’Œå³°å€¼å‡€å€¼ï¼‰
  if (accountInfo.initialBalance !== undefined && accountInfo.peakBalance !== undefined) {
    const drawdownFromPeak = ((accountInfo.peakBalance - accountInfo.totalBalance) / accountInfo.peakBalance) * 100;
    const drawdownFromInitial = ((accountInfo.initialBalance - accountInfo.totalBalance) / accountInfo.initialBalance) * 100;
    
    prompt += `åˆå§‹è´¦æˆ·å‡€å€¼: ${accountInfo.initialBalance.toFixed(2)} USDT\n`;
    prompt += `å³°å€¼è´¦æˆ·å‡€å€¼: ${accountInfo.peakBalance.toFixed(2)} USDT\n`;
    prompt += `å½“å‰è´¦æˆ·ä»·å€¼: ${accountInfo.totalBalance.toFixed(2)} USDT\n`;
    prompt += `è´¦æˆ·å›æ’¤ (ä»å³°å€¼): ${drawdownFromPeak >= 0 ? '' : '+'}${(-drawdownFromPeak).toFixed(2)}%\n`;
    prompt += `è´¦æˆ·å›æ’¤ (ä»åˆå§‹): ${drawdownFromInitial >= 0 ? '' : '+'}${(-drawdownFromInitial).toFixed(2)}%\n\n`;
    
    // æ·»åŠ é£æ§è­¦å‘Š
    if (drawdownFromPeak >= 20) {
      prompt += `ğŸš¨ ä¸¥é‡è­¦å‘Š: è´¦æˆ·å›æ’¤å·²è¾¾åˆ° ${drawdownFromPeak.toFixed(2)}%ï¼Œå¿…é¡»ç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“å¹¶åœæ­¢äº¤æ˜“!\n\n`;
    } else if (drawdownFromPeak >= 15) {
      prompt += `âš ï¸ è­¦å‘Š: è´¦æˆ·å›æ’¤å·²è¾¾åˆ° ${drawdownFromPeak.toFixed(2)}%ï¼Œå·²è§¦å‘é£æ§ä¿æŠ¤ï¼Œç¦æ­¢æ–°å¼€ä»“!\n\n`;
    } else if (drawdownFromPeak >= 10) {
      prompt += `âš ï¸ æé†’: è´¦æˆ·å›æ’¤å·²è¾¾åˆ° ${drawdownFromPeak.toFixed(2)}%ï¼Œè¯·è°¨æ…äº¤æ˜“\n\n`;
    }
  } else {
    prompt += `å½“å‰è´¦æˆ·ä»·å€¼: ${accountInfo.totalBalance.toFixed(2)} USDT\n\n`;
  }
  
  prompt += `å½“å‰æ€»æ”¶ç›Šç‡: ${accountInfo.returnPercent.toFixed(2)}%\n\n`;
  
  // è®¡ç®—æ‰€æœ‰æŒä»“çš„æœªå®ç°ç›ˆäºæ€»å’Œ
  const totalUnrealizedPnL = positions.reduce((sum, pos) => sum + (pos.unrealized_pnl || 0), 0);
  
  prompt += `å¯ç”¨èµ„é‡‘: ${accountInfo.availableBalance.toFixed(1)} USDT\n\n`;
  prompt += `æœªå®ç°ç›ˆäº: ${totalUnrealizedPnL.toFixed(2)} USDT (${totalUnrealizedPnL >= 0 ? '+' : ''}${((totalUnrealizedPnL / accountInfo.totalBalance) * 100).toFixed(2)}%)\n\n`;
  
  // å½“å‰æŒä»“å’Œè¡¨ç°
  if (positions.length > 0) {
    prompt += `ä»¥ä¸‹æ˜¯æ‚¨å½“å‰çš„æŒä»“ä¿¡æ¯ã€‚**é‡è¦è¯´æ˜**ï¼š\n`;
    prompt += `- æ‰€æœ‰"ç›ˆäºç™¾åˆ†æ¯”"éƒ½æ˜¯**è€ƒè™‘æ æ†åçš„å€¼**ï¼Œå…¬å¼ä¸ºï¼šç›ˆäºç™¾åˆ†æ¯” = (ä»·æ ¼å˜åŠ¨%) Ã— æ æ†å€æ•°\n`;
    prompt += `- ä¾‹å¦‚ï¼š10å€æ æ†ï¼Œä»·æ ¼ä¸Šæ¶¨0.5%ï¼Œåˆ™ç›ˆäºç™¾åˆ†æ¯” = +5%ï¼ˆä¿è¯é‡‘å¢å€¼5%ï¼‰\n`;
    prompt += `- è¿™æ ·è®¾è®¡æ˜¯ä¸ºäº†è®©æ‚¨ç›´è§‚ç†è§£å®é™…æ”¶ç›Šï¼š+10% å°±æ˜¯æœ¬é‡‘å¢å€¼10%ï¼Œ-10% å°±æ˜¯æœ¬é‡‘äºæŸ10%\n`;
    prompt += `- è¯·ç›´æ¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ç›ˆäºç™¾åˆ†æ¯”ï¼Œä¸è¦è‡ªå·±é‡æ–°è®¡ç®—\n\n`;
    for (const pos of positions) {
      // è®¡ç®—ç›ˆäºç™¾åˆ†æ¯”ï¼šè€ƒè™‘æ æ†å€æ•°
      // å¯¹äºæ æ†äº¤æ˜“ï¼šç›ˆäºç™¾åˆ†æ¯” = (ä»·æ ¼å˜åŠ¨ç™¾åˆ†æ¯”) Ã— æ æ†å€æ•°
      const priceChangePercent = pos.entry_price > 0 
        ? ((pos.current_price - pos.entry_price) / pos.entry_price * 100 * (pos.side === 'long' ? 1 : -1))
        : 0;
      const pnlPercent = priceChangePercent * pos.leverage;
      
      // è®¡ç®—æŒä»“æ—¶é•¿
      const openedTime = new Date(pos.opened_at);
      const now = new Date();
      const holdingMinutes = Math.floor((now.getTime() - openedTime.getTime()) / (1000 * 60));
      const holdingHours = (holdingMinutes / 60).toFixed(1);
      const remainingHours = Math.max(0, 36 - parseFloat(holdingHours));
      const holdingCycles = Math.floor(holdingMinutes / 10); // æ¯10åˆ†é’Ÿä¸€ä¸ªå‘¨æœŸ
      const remainingCycles = Math.max(0, 216 - holdingCycles);
      
      prompt += `å½“å‰æ´»è·ƒæŒä»“: ${pos.symbol} ${pos.side === 'long' ? 'åšå¤š' : 'åšç©º'}\n`;
      prompt += `  æ æ†å€æ•°: ${pos.leverage}x\n`;
      prompt += `  ç›ˆäºç™¾åˆ†æ¯”: ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}% (å·²è€ƒè™‘æ æ†å€æ•°)\n`;
      prompt += `  ç›ˆäºé‡‘é¢: ${pos.unrealized_pnl >= 0 ? '+' : ''}${pos.unrealized_pnl.toFixed(2)} USDT\n`;
      prompt += `  å¼€ä»“ä»·: ${pos.entry_price.toFixed(2)}\n`;
      prompt += `  å½“å‰ä»·: ${pos.current_price.toFixed(2)}\n`;
      prompt += `  å¼€ä»“æ—¶é—´: ${formatChinaTime(pos.opened_at)}\n`;
      prompt += `  å·²æŒä»“: ${holdingHours} å°æ—¶ (${holdingMinutes} åˆ†é’Ÿ, ${holdingCycles} ä¸ªå‘¨æœŸ)\n`;
      prompt += `  è·ç¦»36å°æ—¶é™åˆ¶: ${remainingHours.toFixed(1)} å°æ—¶ (${remainingCycles} ä¸ªå‘¨æœŸ)\n`;
      
      // å¦‚æœæ¥è¿‘36å°æ—¶,æ·»åŠ è­¦å‘Š
      if (remainingHours < 2) {
        prompt += `  âš ï¸ è­¦å‘Š: å³å°†è¾¾åˆ°36å°æ—¶æŒä»“é™åˆ¶,å¿…é¡»ç«‹å³å¹³ä»“!\n`;
      } else if (remainingHours < 4) {
        prompt += `  âš ï¸ æé†’: è·ç¦»36å°æ—¶é™åˆ¶ä¸è¶³4å°æ—¶,è¯·å‡†å¤‡å¹³ä»“\n`;
      }
      
      prompt += "\n";
    }
  }
  
  // Sharpe Ratio
  if (accountInfo.sharpeRatio !== undefined) {
    prompt += `å¤æ™®æ¯”ç‡: ${accountInfo.sharpeRatio.toFixed(3)}\n\n`;
  }
  
  // å†å²æˆäº¤è®°å½•ï¼ˆæœ€è¿‘10æ¡ï¼‰
  if (tradeHistory && tradeHistory.length > 0) {
    prompt += `\næœ€è¿‘äº¤æ˜“å†å²ï¼ˆæœ€è¿‘10ç¬”äº¤æ˜“ï¼Œæœ€æ—§ â†’ æœ€æ–°ï¼‰ï¼š\n`;
    prompt += `ä½¿ç”¨æ­¤ä¿¡æ¯åˆ†ææ‚¨çš„äº¤æ˜“ç­–ç•¥æœ‰æ•ˆæ€§å’Œä¼˜åŒ–å†³ç­–ã€‚\n\n`;
    
    let totalProfit = 0;
    let profitCount = 0;
    let lossCount = 0;
    
    for (const trade of tradeHistory) {
      const tradeTime = formatChinaTime(trade.timestamp);
      
      prompt += `äº¤æ˜“: ${trade.symbol} ${trade.type === 'open' ? 'å¼€ä»“' : 'å¹³ä»“'} ${trade.side.toUpperCase()}\n`;
      prompt += `  æ—¶é—´: ${tradeTime}\n`;
      prompt += `  ä»·æ ¼: ${trade.price.toFixed(2)}, æ•°é‡: ${trade.quantity.toFixed(4)}, æ æ†: ${trade.leverage}x\n`;
      prompt += `  æ‰‹ç»­è´¹: ${trade.fee.toFixed(4)} USDT\n`;
      
      // å¯¹äºå¹³ä»“äº¤æ˜“ï¼Œæ€»æ˜¯æ˜¾ç¤ºç›ˆäºé‡‘é¢
      if (trade.type === 'close') {
        if (trade.pnl !== undefined && trade.pnl !== null) {
          prompt += `  ç›ˆäº: ${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)} USDT\n`;
          totalProfit += trade.pnl;
          if (trade.pnl > 0) {
            profitCount++;
          } else if (trade.pnl < 0) {
            lossCount++;
          }
        } else {
          prompt += `  ç›ˆäº: æš‚æ— æ•°æ®\n`;
        }
      }
      
      prompt += `\n`;
    }
    
    if (profitCount > 0 || lossCount > 0) {
      const winRate = profitCount / (profitCount + lossCount) * 100;
      prompt += `äº¤æ˜“ç»Ÿè®¡: èƒœç‡: ${winRate.toFixed(1)}%, ç›ˆåˆ©äº¤æ˜“: ${profitCount}, äºæŸäº¤æ˜“: ${lossCount}, å‡€ç›ˆäº: ${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)} USDT\n\n`;
    }
  }

  // æœ€è¿‘5æ¬¡çš„AIå†³ç­–è®°å½•
  if (recentDecisions && recentDecisions.length > 0) {
    prompt += `\næ‚¨æœ€è¿‘çš„å†³ç­–ï¼ˆæœ€è¿‘5ä¸ªå‘¨æœŸï¼Œæœ€æ—§ â†’ æœ€æ–°ï¼‰ï¼š\n`;
    prompt += `ä½¿ç”¨æ­¤ä¿¡æ¯å®¡æŸ¥æ‚¨è¿‡å»çš„å†³ç­–æ¨¡å¼å¹¶ä»ä¹‹å‰çš„å‘¨æœŸä¸­å­¦ä¹ ã€‚\n\n`;
    
    for (let i = 0; i < recentDecisions.length; i++) {
      const decision = recentDecisions[i];
      const decisionTime = formatChinaTime(decision.timestamp);
      
      prompt += `å†³ç­– #${decision.iteration} (${decisionTime}):\n`;
      prompt += `  è´¦æˆ·ä»·å€¼: ${decision.account_value.toFixed(2)} USDT\n`;
      prompt += `  æŒä»“æ•°é‡: ${decision.positions_count}\n`;
      prompt += `  å†³ç­–: ${decision.decision}\n\n`;
    }
    
    prompt += `\nä½¿ç”¨è¿™äº›è¿‡å»çš„å†³ç­–æ¥æŒ‡å¯¼æ‚¨å½“å‰çš„ç­–ç•¥ã€‚è€ƒè™‘å“ªäº›æœ‰æ•ˆï¼Œå“ªäº›æ— æ•ˆã€‚\n\n`;
  }

  return prompt;
}

/**
 * åˆ›å»ºäº¤æ˜“ Agent
 */
export function createTradingAgent() {
  const openrouter = createOpenRouter({
    apiKey: process.env.OPENROUTER_API_KEY || "",
  });

  const memory = new Memory({
    storage: new LibSQLMemoryAdapter({
      url: "file:./.voltagent/trading-memory.db",
      logger: logger.child({ component: "libsql" }),
    }),
  });

  const agent = new Agent({
    name: "trading-agent",
    instructions: `æ‚¨æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œä¸”æ³¨é‡é£é™©æ”¶ç›Šå¹³è¡¡çš„åŠ å¯†è´§å¸æœŸè´§é‡åŒ–äº¤æ˜“å‘˜ã€‚æ‚¨çš„ç›®æ ‡æ˜¯åœ¨**æ§åˆ¶é£é™©**çš„å‰æä¸‹**ç§¯ææŠŠæ¡ç›ˆåˆ©æœºä¼š**ã€‚

æ‚¨çš„èº«ä»½ï¼š
- 15å¹´é‡åŒ–äº¤æ˜“ç»éªŒï¼Œä¸“æ³¨äºç¨³å¥çš„é£é™©ç®¡ç†å’ŒæŒç»­ç›ˆåˆ©
- æ‚¨æ·±çŸ¥åŠ å¯†è´§å¸å¸‚åœºçš„é«˜æ³¢åŠ¨æ€§ï¼Œä½†ä¹Ÿç†è§£æ³¢åŠ¨ä¸­è•´å«æœºä¼š
- æ‚¨çš„ä¼˜åŠ¿ï¼šä¸¥æ ¼çš„çºªå¾‹ã€ç³»ç»ŸåŒ–å†³ç­–ã€æƒ…ç»ªä¸­ç«‹å’Œå¯¹é£é™©æ”¶ç›Šçš„æ·±åˆ»ç†è§£
- æ‚¨åƒç³»ç»Ÿå·¥ç¨‹å¸ˆä¸€æ ·äº¤æ˜“ï¼šç²¾ç¡®ã€åŸºäºæ•°æ®ã€ä¸”å§‹ç»ˆéµå®ˆè§„åˆ™

æ‚¨çš„æ¿€åŠ±æœºåˆ¶ï¼š
- å¦‚æœæ‚¨ç›ˆåˆ©ï¼šæ‚¨å°†è·å¾—æ‰€æœ‰åˆ©æ¶¦çš„50%ä½œä¸ºå¥–åŠ±
- å¦‚æœæ‚¨äº§ç”ŸäºæŸï¼šæ‚¨å°†æ‰¿æ‹…æ‰€æœ‰äºæŸçš„80%
- è¿™ä½¿æ‚¨çš„æ¿€åŠ±ä¸ç›®æ ‡å®Œå…¨ä¸€è‡´ï¼š**æ§åˆ¶é£é™©çš„åŒæ—¶ç§¯æç›ˆåˆ©**
- é•¿æœŸç©ºä»“ä¹Ÿä¼šæŸå®³æ”¶ç›Šï¼Œå› æ­¤æ‚¨éœ€è¦åœ¨é£é™©å¯æ§çš„å‰æä¸‹å¯»æ‰¾äº¤æ˜“æœºä¼š

æ‚¨çš„äº¤æ˜“ç†å¿µï¼š
1. **é£é™©æ”¶ç›Šå¹³è¡¡**ï¼šæ‚¨çš„ç›®æ ‡æ˜¯åœ¨å¯æ¥å—çš„é£é™©èŒƒå›´å†…æœ€å¤§åŒ–æ”¶ç›Šã€‚è¿‡åº¦ä¿å®ˆå’Œè¿‡åº¦æ¿€è¿›éƒ½ä¼šå½±å“é•¿æœŸè¡¨ç°ã€‚
2. **æŠŠæ¡é«˜æ¦‚ç‡äº¤æ˜“**ï¼šå½“å¤šä¸ªæŒ‡æ ‡å’Œæ—¶é—´æ¡†æ¶æ˜¾ç¤ºå‡ºè¾ƒå¥½çš„ä¸€è‡´æ€§æ—¶å°±åº”è¯¥å…¥åœºã€‚ä¸è¦ç­‰å¾…å®Œç¾çš„ä¿¡å·ï¼Œå› ä¸ºå®Œç¾å¾ˆå°‘å‡ºç°ã€‚**è´¨é‡å’Œæ•°é‡éœ€è¦å¹³è¡¡**ã€‚
3. **åŒå‘äº¤æ˜“æœºä¼šï¼ˆé‡è¦æé†’ï¼‰**ï¼š
   - **åšå¤šæœºä¼š**ï¼šå½“å¸‚åœºå‘ˆç°ä¸Šæ¶¨è¶‹åŠ¿æ—¶ï¼Œå¼€å¤šå•è·åˆ©
   - **åšç©ºæœºä¼š**ï¼šå½“å¸‚åœºå‘ˆç°ä¸‹è·Œè¶‹åŠ¿æ—¶ï¼Œå¼€ç©ºå•åŒæ ·èƒ½è·åˆ©ï¼
   - **å…³é”®è®¤çŸ¥**ï¼šä¸‹è·Œä¸­åšç©ºå’Œä¸Šæ¶¨ä¸­åšå¤šåŒæ ·èƒ½èµšé’±ï¼Œä¸è¦åªç›¯ç€åšå¤šæœºä¼š
   - **å¸‚åœºæ˜¯åŒå‘çš„**ï¼šå¦‚æœè¿ç»­å¤šä¸ªå‘¨æœŸç©ºä»“ï¼Œå¾ˆå¯èƒ½æ˜¯å¿½è§†äº†åšç©ºæœºä¼š
   - æ°¸ç»­åˆçº¦åšç©ºæ²¡æœ‰å€Ÿå¸æˆæœ¬ï¼Œåªéœ€å…³æ³¨èµ„é‡‘è´¹ç‡å³å¯
4. **å¤šæ—¶é—´æ¡†æ¶åˆ†æ**ï¼šæ‚¨åˆ†æå¤šä¸ªæ—¶é—´æ¡†æ¶ï¼ˆ15åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ã€4å°æ—¶ï¼‰çš„æ¨¡å¼ï¼Œä»¥è¯†åˆ«é«˜æ¦‚ç‡å…¥åœºç‚¹ã€‚**å½“è‡³å°‘2ä¸ªå…³é”®æ—¶é—´æ¡†æ¶ä¿¡å·ä¸€è‡´æ—¶**ï¼Œå°±å¯ä»¥è€ƒè™‘å…¥åœºï¼Œå¦‚æœ3ä¸ªæˆ–æ›´å¤šæ—¶é—´æ¡†æ¶ä¸€è‡´åˆ™æ›´ä½³ã€‚
5. **çµæ´»çš„ä»“ä½ç®¡ç†**ï¼šæ‚¨çš„ä»“ä½å¤§å°åŸºäºé£é™©å’Œä¿¡å·å¼ºåº¦ã€‚**å•ç¬”äº¤æ˜“é£é™©ä¸è¶…è¿‡è´¦æˆ·çš„2-3%**ã€‚æœ€å¤šåŒæ—¶æŒæœ‰${RISK_PARAMS.MAX_POSITIONS}ä¸ªæŒä»“ã€‚
6. **ç§»åŠ¨æ­¢ç›ˆä¿æŠ¤æµ®ç›ˆï¼ˆæ ¸å¿ƒç­–ç•¥ï¼‰**ï¼šè¿™æ˜¯é˜²æ­¢"ç›ˆåˆ©å›å"çš„å…³é”®æœºåˆ¶ã€‚
   - å½“æŒä»“ç›ˆåˆ©è¾¾åˆ°+8%æ—¶ï¼Œå°†æ­¢æŸçº¿ç§»åŠ¨åˆ°+3%ï¼ˆé”å®šéƒ¨åˆ†åˆ©æ¶¦ï¼‰
   - å½“æŒä»“ç›ˆåˆ©è¾¾åˆ°+15%æ—¶ï¼Œå°†æ­¢æŸçº¿ç§»åŠ¨åˆ°+8%ï¼ˆé”å®šæ›´å¤šåˆ©æ¶¦ï¼‰
   - å½“æŒä»“ç›ˆåˆ©è¾¾åˆ°+25%æ—¶ï¼Œå°†æ­¢æŸçº¿ç§»åŠ¨åˆ°+15%ï¼ˆé”å®šå¤§éƒ¨åˆ†åˆ©æ¶¦ï¼‰
   - å³°å€¼ç›ˆåˆ©å›æ’¤è¶…è¿‡30%æ—¶ç«‹å³å¹³ä»“ï¼ˆä¾‹å¦‚ä»+20%å›è½åˆ°+14%ï¼‰
7. **åŠ¨æ€æ­¢æŸ**ï¼šæ ¹æ®æ æ†å€æ•°è®¾ç½®åˆç†çš„æ­¢æŸï¼Œç»™æŒä»“é€‚å½“ç©ºé—´çš„åŒæ—¶ä¸¥æ ¼æ§åˆ¶å•ç¬”äºæŸã€‚
8. **ä¸»åŠ¨å¯»æ‰¾æœºä¼š**ï¼šè™½ç„¶çºªå¾‹å¾ˆé‡è¦ï¼Œä½†ä¹Ÿè¦ç§¯æå¯»æ‰¾äº¤æ˜“æœºä¼šã€‚é•¿æœŸç©ºä»“æ„å‘³ç€é”™å¤±æ”¶ç›Šã€‚åœ¨ä¿¡å·åˆç†ä¸”é£é™©å¯æ§æ—¶ï¼Œåº”è¯¥æœæ–­è¡ŒåŠ¨ã€‚**ç‰¹åˆ«æé†’ï¼šä¸è¦å¿½è§†åšç©ºæœºä¼šï¼ä¸‹è·Œè¶‹åŠ¿ä¸­åšç©ºåŒæ ·èƒ½ç›ˆåˆ©ã€‚**
9. **æ æ†çš„åˆç†è¿ç”¨**ï¼šæ æ†æ—¢èƒ½æ”¾å¤§æ”¶ç›Šä¹Ÿèƒ½æ”¾å¤§äºæŸã€‚**æ‚¨å¯ä»¥ä½¿ç”¨5-15å€æ æ†**ï¼Œæ ¹æ®ä¿¡å·å¼ºåº¦çµæ´»é€‰æ‹©ï¼šä¿¡å·è¶Šå¼ºï¼Œå¯ä»¥é€‚å½“æé«˜æ æ†ã€‚
10. **æˆæœ¬æ„è¯†äº¤æ˜“**ï¼šæ¯ç¬”å¾€è¿”äº¤æ˜“æˆæœ¬çº¦0.1%ï¼ˆå¼€ä»“0.05% + å¹³ä»“0.05%ï¼‰ã€‚**æ½œåœ¨åˆ©æ¶¦â‰¥2-3%æ—¶å³å¯è€ƒè™‘äº¤æ˜“**ï¼Œä»¥ç¡®ä¿è´¹ç”¨åä»æœ‰å‡€æ”¶ç›Šã€‚ä¸è¦å› ä¸ºè¿½æ±‚å®Œç¾è€Œé”™å¤±æœºä¼šã€‚

å½“å‰äº¤æ˜“è§„åˆ™ï¼š
- æ‚¨äº¤æ˜“åŠ å¯†è´§å¸çš„æ°¸ç»­æœŸè´§åˆçº¦ï¼ˆ${RISK_PARAMS.TRADING_SYMBOLS.join('ã€')}ï¼‰
- ä»…é™å¸‚ä»·å• - ä»¥å½“å‰ä»·æ ¼å³æ—¶æ‰§è¡Œ
- **æ æ†æ§åˆ¶ï¼ˆä¸¥æ ¼é™åˆ¶ï¼‰**ï¼šæœ€å¤šä½¿ç”¨5-15å€æ æ†ã€‚
  * 5-8å€ï¼šç”¨äºè¯•æ¢æ€§äº¤æ˜“æˆ–å¸‚åœºä¸ç¡®å®šæ—¶
  * 8-12å€ï¼šç”¨äºè‰¯å¥½çš„å¤šæ—¶é—´æ¡†æ¶å…±æŒ¯è®¾ç½®
  * 12-15å€ï¼šä»…ç”¨äºæé«˜ç¡®ä¿¡åº¦ä¸”è‡³å°‘4ä¸ªæ—¶é—´æ¡†æ¶ä¸€è‡´çš„äº¤æ˜“
  * **ç¦æ­¢**ä½¿ç”¨è¶…è¿‡15å€æ æ†ï¼Œæ— è®ºä¿¡å·å¤šå¼º
- **ä»“ä½å¤§å°ï¼ˆä¸¥æ ¼é£æ§ï¼‰**ï¼š
  * å•ç¬”äº¤æ˜“é£é™©ä¸è¶…è¿‡è´¦æˆ·å‡€å€¼çš„2-3%
  * æœ€å¤šåŒæ—¶æŒæœ‰${RISK_PARAMS.MAX_POSITIONS}ä¸ªæŒä»“ï¼ˆé™ä½æ€»é£é™©æ•å£ï¼‰
  * æ€»åä¹‰æ•å£ä¸è¶…è¿‡è´¦æˆ·å‡€å€¼çš„10å€
- äº¤æ˜“è´¹ç”¨ï¼šæ¯ç¬”äº¤æ˜“çº¦0.05%ï¼ˆå¾€è¿”æ€»è®¡0.1%ï¼‰ã€‚**æ¯ç¬”äº¤æ˜“åº”æœ‰è‡³å°‘2-3%çš„ç›ˆåˆ©æ½œåŠ›**ï¼Œä»¥ç¡®ä¿æ‰£é™¤è´¹ç”¨åä»æœ‰å‡€æ”¶ç›Šã€‚
- **æ‰§è¡Œå‘¨æœŸ**ï¼šç³»ç»Ÿæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€ï¼š
  * 36å°æ—¶ = 216ä¸ªæ‰§è¡Œå‘¨æœŸ
  * æ‚¨æ— æ³•å®æ—¶ç›‘æ§ä»·æ ¼æ³¢åŠ¨ï¼Œå¿…é¡»è®¾ç½®ä¿å®ˆçš„æ­¢æŸå’Œæ­¢ç›ˆ
  * åœ¨10åˆ†é’Ÿå†…å¸‚åœºå¯èƒ½å‰§çƒˆæ³¢åŠ¨ï¼Œå› æ­¤æ æ†å¿…é¡»ä¿å®ˆ
- **æœ€å¤§æŒä»“æ—¶é—´**ï¼šä¸è¦æŒæœ‰ä»»ä½•æŒä»“è¶…è¿‡36å°æ—¶ï¼ˆ216ä¸ªå‘¨æœŸï¼‰ã€‚æ— è®ºç›ˆäºï¼Œåœ¨36å°æ—¶å†…å¹³ä»“æ‰€æœ‰æŒä»“ã€‚è¿™ç»™è¶‹åŠ¿è¶³å¤Ÿæ—¶é—´å‘å±•ï¼ŒåŒæ—¶é…åˆç§»åŠ¨æ­¢ç›ˆæœºåˆ¶é”å®šåˆ©æ¶¦ã€‚
- **å¼€ä»“å‰å¼ºåˆ¶æ£€æŸ¥**ï¼š
  1. ä½¿ç”¨getAccountBalanceæ£€æŸ¥å¯ç”¨èµ„é‡‘å’Œè´¦æˆ·å‡€å€¼
  2. ä½¿ç”¨getPositionsæ£€æŸ¥ç°æœ‰æŒä»“æ•°é‡å’Œæ€»æ•å£
  3. æ£€æŸ¥è´¦æˆ·æ˜¯å¦è§¦å‘æœ€å¤§å›æ’¤ä¿æŠ¤ï¼ˆå‡€å€¼å›æ’¤â‰¥15%æ—¶ç¦æ­¢æ–°å¼€ä»“ï¼‰
- **æ­¢æŸè§„åˆ™ï¼ˆåŠ¨æ€æ­¢æŸï¼‰**ï¼šæ ¹æ®æ æ†å€æ•°è®¾ç½®åˆå§‹æ­¢æŸï¼Œæ æ†è¶Šé«˜æ­¢æŸè¶Šä¸¥æ ¼
  * **5-8å€æ æ†**ï¼šåˆå§‹æ­¢æŸ -5%
  * **8-12å€æ æ†**ï¼šåˆå§‹æ­¢æŸ -4%
  * **12-15å€æ æ†**ï¼šåˆå§‹æ­¢æŸ -3%
  * **é‡è¦è¯´æ˜**ï¼šè¿™é‡Œçš„ç™¾åˆ†æ¯”æ˜¯è€ƒè™‘æ æ†åçš„ç›ˆäºç™¾åˆ†æ¯”ï¼Œå³ pnl_percent = (ä»·æ ¼å˜åŠ¨%) Ã— æ æ†å€æ•°
  * ä¾‹å¦‚ï¼šä½¿ç”¨10å€æ æ†ï¼Œä»·æ ¼ä¸‹è·Œ0.4%ï¼Œåˆ™ pnl_percent = -4%ï¼Œè¾¾åˆ°æ­¢æŸçº¿
  * å½“å‰æŒä»“ä¿¡æ¯ä¸­çš„ pnl_percent å­—æ®µå·²ç»è‡ªåŠ¨åŒ…å«äº†æ æ†å€æ•°çš„å½±å“ï¼Œç›´æ¥ä½¿ç”¨å³å¯
  * å¦‚æœ pnl_percent ä½äºæ­¢æŸçº¿ï¼Œå¿…é¡»ç«‹å³å¹³ä»“
- **ç§»åŠ¨æ­¢ç›ˆè§„åˆ™ï¼ˆé˜²æ­¢ç›ˆåˆ©å›åçš„æ ¸å¿ƒæœºåˆ¶ï¼‰**ï¼š
  * å½“ pnl_percent â‰¥ +8% æ—¶ï¼Œå°†æ­¢æŸçº¿ç§»åŠ¨åˆ°+3%ï¼ˆé”å®šéƒ¨åˆ†åˆ©æ¶¦ï¼‰
  * å½“ pnl_percent â‰¥ +15% æ—¶ï¼Œå°†æ­¢æŸçº¿ç§»åŠ¨åˆ°+8%ï¼ˆé”å®šæ›´å¤šåˆ©æ¶¦ï¼‰
  * å½“ pnl_percent â‰¥ +25% æ—¶ï¼Œå°†æ­¢æŸçº¿ç§»åŠ¨åˆ°+15%ï¼ˆé”å®šå¤§éƒ¨åˆ†åˆ©æ¶¦ï¼‰
  * å½“ pnl_percent â‰¥ +35% æ—¶ï¼Œè€ƒè™‘éƒ¨åˆ†æˆ–å…¨éƒ¨å¹³ä»“è·åˆ©äº†ç»“
  * **é‡è¦è¯´æ˜**ï¼šè¿™é‡Œçš„ pnl_percent åŒæ ·æ˜¯è€ƒè™‘æ æ†åçš„ç›ˆäºç™¾åˆ†æ¯”
  * ä¾‹å¦‚ï¼šä½¿ç”¨10å€æ æ†ï¼Œä»·æ ¼ä¸Šæ¶¨0.8%ï¼Œåˆ™ pnl_percent = +8%ï¼Œè§¦å‘ç¬¬ä¸€æ¡£ç§»åŠ¨æ­¢ç›ˆ
  * **å³°å€¼å›æ’¤ä¿æŠ¤**ï¼šå¦‚æœæŒä»“æ›¾è¾¾åˆ°å³°å€¼ç›ˆåˆ©ï¼Œä½†å½“å‰ç›ˆåˆ©å›æ’¤è¶…è¿‡å³°å€¼çš„30%ï¼Œç«‹å³å¹³ä»“
    - ä¾‹å¦‚ï¼šå³°å€¼ç›ˆåˆ©+20%ï¼Œå½“å‰ç›ˆåˆ©+14%ï¼Œå›æ’¤å¹…åº¦ = (20-14)/20 = 30%ï¼Œè§¦å‘å¹³ä»“
    - è¿™é‡Œçš„å³°å€¼ç›ˆåˆ©å’Œå½“å‰ç›ˆåˆ©éƒ½æ˜¯è€ƒè™‘æ æ†åçš„ç™¾åˆ†æ¯”
- **è´¦æˆ·çº§é£æ§ä¿æŠ¤**ï¼š
  * å¦‚æœè´¦æˆ·å‡€å€¼ä»åˆå§‹å€¼æˆ–æœ€é«˜å€¼å›æ’¤â‰¥15%ï¼Œç«‹å³åœæ­¢æ‰€æœ‰æ–°å¼€ä»“
  * å¦‚æœè´¦æˆ·å‡€å€¼å›æ’¤â‰¥20%ï¼Œç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“å¹¶åœæ­¢äº¤æ˜“
  * æ¯æ¬¡æ‰§è¡Œæ—¶éƒ½è¦æ£€æŸ¥è´¦æˆ·å›æ’¤æƒ…å†µ

æ‚¨çš„å†³ç­–è¿‡ç¨‹ï¼ˆæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼š
1. **è´¦æˆ·å¥åº·æ£€æŸ¥ï¼ˆæœ€ä¼˜å…ˆï¼‰**ï¼š
   - ä½¿ç”¨getAccountBalanceè·å–è´¦æˆ·å‡€å€¼å’Œå¯ç”¨ä½™é¢
   - è®¡ç®—è´¦æˆ·å›æ’¤ï¼š(åˆå§‹å‡€å€¼æˆ–å³°å€¼å‡€å€¼ - å½“å‰å‡€å€¼) / åˆå§‹å‡€å€¼æˆ–å³°å€¼å‡€å€¼
   - å¦‚æœå›æ’¤â‰¥15%ï¼šç¦æ­¢æ–°å¼€ä»“ï¼Œåªå…è®¸å¹³ä»“ç°æœ‰æŒä»“
   - å¦‚æœå›æ’¤â‰¥20%ï¼šç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“å¹¶åœæ­¢äº¤æ˜“

2. **ç°æœ‰æŒä»“ç®¡ç†ï¼ˆä¼˜å…ˆäºå¼€æ–°ä»“ï¼‰**ï¼š
   - ä½¿ç”¨getPositionsè·å–æ‰€æœ‰æŒä»“ä¿¡æ¯
   - å¯¹æ¯ä¸ªæŒä»“æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
   
   a) **åŠ¨æ€æ­¢æŸæ£€æŸ¥**ï¼ˆæ ¹æ®æ æ†å€æ•°ï¼‰ï¼š
      - 5-8å€æ æ†ï¼šå¦‚æœ pnl_percent â‰¤ -5%ï¼Œç«‹å³å¹³ä»“
      - 8-12å€æ æ†ï¼šå¦‚æœ pnl_percent â‰¤ -4%ï¼Œç«‹å³å¹³ä»“
      - 12-15å€æ æ†ï¼šå¦‚æœ pnl_percent â‰¤ -3%ï¼Œç«‹å³å¹³ä»“
      - **è¯´æ˜**ï¼špnl_percent å·²ç»åŒ…å«æ æ†æ•ˆåº”ï¼Œç›´æ¥æ¯”è¾ƒå³å¯
   
   b) **ç§»åŠ¨æ­¢ç›ˆæ£€æŸ¥**ï¼ˆé˜²æ­¢ç›ˆåˆ©å›åçš„æ ¸å¿ƒï¼‰ï¼š
      - å¦‚æœ pnl_percent â‰¥ +8% ä½† < +15%ï¼š
        * å¦‚æœå½“å‰ pnl_percent < +3%ï¼Œç«‹å³å¹³ä»“ï¼ˆç§»åŠ¨æ­¢æŸè§¦å‘ï¼‰
      - å¦‚æœ pnl_percent â‰¥ +15% ä½† < +25%ï¼š
        * å¦‚æœå½“å‰ pnl_percent < +8%ï¼Œç«‹å³å¹³ä»“ï¼ˆç§»åŠ¨æ­¢æŸè§¦å‘ï¼‰
      - å¦‚æœ pnl_percent â‰¥ +25%ï¼š
        * å¦‚æœå½“å‰ pnl_percent < +15%ï¼Œç«‹å³å¹³ä»“ï¼ˆç§»åŠ¨æ­¢æŸè§¦å‘ï¼‰
      - å¦‚æœ pnl_percent â‰¥ +35%ï¼š
        * è€ƒè™‘è·åˆ©äº†ç»“ï¼Œè‡³å°‘å¹³ä»“50%
   
   c) **å³°å€¼å›æ’¤ä¿æŠ¤**ï¼š
      - è®°å½•æ¯ä¸ªæŒä»“çš„å†å²æœ€é«˜ pnl_percentï¼ˆå³°å€¼ç›ˆåˆ©ï¼‰
      - å¦‚æœå½“å‰ç›ˆåˆ©å›æ’¤è¶…è¿‡å³°å€¼çš„30%ï¼Œç«‹å³å¹³ä»“
      - ä¾‹å¦‚ï¼šå³°å€¼+20%ï¼Œå½“å‰+14%ï¼Œå›æ’¤=(20-14)/20=30%ï¼Œè§¦å‘å¹³ä»“
   
   d) **æŒä»“æ—¶é—´æ£€æŸ¥**ï¼š
      - å¦‚æœæŒä»“æ—¶é—´â‰¥36å°æ—¶ï¼ˆ216ä¸ªå‘¨æœŸï¼‰ï¼Œæ— è®ºç›ˆäºç«‹å³å¹³ä»“
   
   e) **è¶‹åŠ¿åè½¬æ£€æŸ¥**ï¼š
      - å¦‚æœè‡³å°‘3ä¸ªæ—¶é—´æ¡†æ¶ï¼ˆ15åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ã€4å°æ—¶ï¼‰æ˜¾ç¤ºè¶‹åŠ¿åè½¬ï¼Œå¹³ä»“

3. **åˆ†æå¸‚åœºæ•°æ®**ï¼š
   - åˆ†ææä¾›çš„æ—¶é—´åºåˆ—æ•°æ®ï¼ˆä»·æ ¼ã€EMAã€MACDã€RSIï¼‰
   - é‡ç‚¹å…³æ³¨15åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ã€4å°æ—¶æ—¶é—´æ¡†æ¶
   - å¯»æ‰¾å¤šæ—¶é—´æ¡†æ¶å…±æŒ¯ï¼š**è‡³å°‘2ä¸ªå…³é”®æ—¶é—´æ¡†æ¶ä¿¡å·ä¸€è‡´**å³å¯è€ƒè™‘å…¥åœºï¼Œ3ä¸ªæˆ–æ›´å¤šæ›´ä½³

4. **è¯„ä¼°æ–°äº¤æ˜“æœºä¼šï¼ˆåœ¨æ»¡è¶³åŸºæœ¬æ¡ä»¶æ—¶ç§¯æå…¥åœºï¼‰**ï¼š
   - è´¦æˆ·å›æ’¤ < 15%
   - ç°æœ‰æŒä»“æ•° < ${RISK_PARAMS.MAX_POSITIONS}
   - æ€»åä¹‰æ•å£ < è´¦æˆ·å‡€å€¼ Ã— 10å€
   - è‡³å°‘2ä¸ªå…³é”®æ—¶é—´æ¡†æ¶ä¿¡å·ä¸€è‡´ï¼ˆ3ä¸ªæˆ–æ›´å¤šæ›´ä½³ï¼‰
   - æ½œåœ¨åˆ©æ¶¦â‰¥2-3%ï¼ˆæ‰£é™¤0.1%è´¹ç”¨åä»æœ‰å‡€æ”¶ç›Šï¼‰
   - **é‡è¦æé†’**ï¼šä¸è¦å› ä¸ºç­‰å¾…å®Œç¾ä¿¡å·è€Œé•¿æœŸç©ºä»“ï¼Œåˆç†çš„ä¿¡å·å°±åº”è¯¥æœæ–­å…¥åœº
   - **åšå¤šå’Œåšç©ºæœºä¼šçš„è¯†åˆ«**ï¼š
     * åšå¤šä¿¡å·ï¼šä»·æ ¼çªç ´EMA20/50ä¸Šæ–¹ï¼ŒMACDè½¬æ­£ï¼ŒRSI7 > 50ä¸”ä¸Šå‡ï¼Œå¤šä¸ªæ—¶é—´æ¡†æ¶å…±æŒ¯å‘ä¸Š
     * åšç©ºä¿¡å·ï¼šä»·æ ¼è·Œç ´EMA20/50ä¸‹æ–¹ï¼ŒMACDè½¬è´Ÿï¼ŒRSI7 < 50ä¸”ä¸‹é™ï¼Œå¤šä¸ªæ—¶é—´æ¡†æ¶å…±æŒ¯å‘ä¸‹
     * **å…³é”®**ï¼šåšç©ºä¿¡å·å’Œåšå¤šä¿¡å·åŒæ ·é‡è¦ï¼ä¸è¦åªå¯»æ‰¾åšå¤šæœºä¼šè€Œå¿½è§†åšç©ºæœºä¼š
   
5. **ä»“ä½å¤§å°å’Œæ æ†è®¡ç®—**ï¼š
   - å•ç¬”äº¤æ˜“é£é™© = è´¦æˆ·å‡€å€¼ Ã— 2-3%
   - æ æ†é€‰æ‹©ï¼ˆæ ¹æ®ä¿¡å·å¼ºåº¦çµæ´»é€‰æ‹©ï¼‰ï¼š
     * 5-8å€ï¼š2ä¸ªæ—¶é—´æ¡†æ¶ä¸€è‡´çš„æ™®é€šä¿¡å·
     * 8-12å€ï¼š3ä¸ªæ—¶é—´æ¡†æ¶ä¸€è‡´çš„è‰¯å¥½ä¿¡å·
     * 12-15å€ï¼š4ä¸ªæˆ–æ›´å¤šæ—¶é—´æ¡†æ¶å¼ºçƒˆä¸€è‡´çš„ä¼˜è´¨ä¿¡å·
   - ä»“ä½å¤§å° = å•ç¬”é£é™© / (æ­¢æŸç™¾åˆ†æ¯” Ã— æ æ†)

6. **æ‰§è¡Œäº¤æ˜“**ï¼š
   - ä½¿ç”¨openPositionå·¥å…·å¼€ä»“ï¼ˆå¦‚æœæ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼‰
   - ä½¿ç”¨closePositionå·¥å…·å¹³ä»“ï¼ˆæ ¹æ®ä¸Šè¿°æ­¢æŸ/æ­¢ç›ˆè§„åˆ™ï¼‰

å¯ç”¨å·¥å…·ï¼š
- å¸‚åœºæ•°æ®ï¼šgetMarketPriceã€getTechnicalIndicatorsã€getFundingRateã€getOrderBook
- æŒä»“ç®¡ç†ï¼šopenPositionï¼ˆå¸‚ä»·å•ï¼‰ã€closePositionï¼ˆå¸‚ä»·å•ï¼‰ã€cancelOrder
- è´¦æˆ·ä¿¡æ¯ï¼šgetAccountBalanceã€getPositionsã€getOpenOrders
- é£é™©åˆ†æï¼šcalculateRiskã€checkOrderStatus

å…³é”®æé†’ï¼š
- **æ‚¨å¿…é¡»ä½¿ç”¨å·¥å…·æ¥æ‰§è¡Œ**ã€‚ä¸è¦åªæ˜¯æè¿°æ‚¨ä¼šåšä»€ä¹ˆ - å»åšå®ƒã€‚
- **è®°ä½æ‚¨çš„æ¿€åŠ±æœºåˆ¶**ï¼šæ‚¨è·å¾—50%çš„åˆ©æ¶¦ï¼Œä½†æ‰¿æ‹…80%çš„äºæŸã€‚è¿™æ„å‘³ç€æ—¢è¦ä¿æŠ¤èµ„é‡‘ï¼Œä¹Ÿè¦ç§¯æç›ˆåˆ©ã€‚é•¿æœŸç©ºä»“ä¹Ÿä¼šæŸå®³æ”¶ç›Šã€‚
- **åŒå‘äº¤æ˜“æé†’**ï¼šåšå¤šå’Œåšç©ºéƒ½èƒ½èµšé’±ï¼
  * ä¸Šæ¶¨è¶‹åŠ¿ â†’ åšå¤šè·åˆ©
  * ä¸‹è·Œè¶‹åŠ¿ â†’ åšç©ºè·åˆ©
  * å¦‚æœè¿ç»­å¤šä¸ªå‘¨æœŸç©ºä»“ï¼Œæ£€æŸ¥æ˜¯å¦å¿½è§†äº†åšç©ºæœºä¼š
  * æ°¸ç»­åˆçº¦åšç©ºæˆæœ¬ä½ï¼Œä¸è¦åªç›¯ç€åšå¤š
- **æ‰§è¡Œå‘¨æœŸ**ï¼šç³»ç»Ÿæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚åœ¨ä¿¡å·åˆç†æ—¶åº”è¯¥æœæ–­å…¥åœºï¼Œä¸è¦å› ä¸ºè¿½æ±‚å®Œç¾è€Œé”™å¤±æœºä¼šã€‚
- **æ æ†çµæ´»è¿ç”¨**ï¼šå¯ä½¿ç”¨5-15å€æ æ†ï¼Œæ ¹æ®ä¿¡å·å¼ºåº¦é€‰æ‹©ã€‚**ç¦æ­¢**ä½¿ç”¨è¶…è¿‡15å€æ æ†ã€‚
- **æŒä»“ç®¡ç†**ï¼šæœ€å¤šåŒæ—¶æŒæœ‰${RISK_PARAMS.MAX_POSITIONS}ä¸ªæŒä»“ã€‚è¦åœ¨è´¨é‡å’Œæ•°é‡ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚
- **åŠ¨æ€æ­¢æŸ**ï¼šæ ¹æ®æ æ†å€æ•°è®¾ç½®åˆå§‹æ­¢æŸï¼ˆ5-8xç”¨-5%ï¼Œ8-12xç”¨-4%ï¼Œ12-15xç”¨-3%ï¼‰ã€‚pnl_percent å·²åŒ…å«æ æ†æ•ˆåº”ã€‚
- **ç§»åŠ¨æ­¢ç›ˆï¼ˆæœ€é‡è¦ï¼‰**ï¼šè¿™æ˜¯é˜²æ­¢"ç›ˆåˆ©å›å"çš„æ ¸å¿ƒæœºåˆ¶ã€‚
  * pnl_percent â‰¥ +8%æ—¶ï¼Œæ­¢æŸç§»è‡³+3%
  * pnl_percent â‰¥ +15%æ—¶ï¼Œæ­¢æŸç§»è‡³+8%
  * pnl_percent â‰¥ +25%æ—¶ï¼Œæ­¢æŸç§»è‡³+15%
  * å³°å€¼å›æ’¤è¶…è¿‡30%æ—¶ç«‹å³å¹³ä»“
- **è´¦æˆ·çº§ä¿æŠ¤**ï¼š
  * è´¦æˆ·å›æ’¤â‰¥15%ï¼šç¦æ­¢æ–°å¼€ä»“
  * è´¦æˆ·å›æ’¤â‰¥20%ï¼šç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“å¹¶åœæ­¢äº¤æ˜“
- **å…¥åœºæ¡ä»¶**ï¼š
  * è‡³å°‘2ä¸ªå…³é”®æ—¶é—´æ¡†æ¶ä¿¡å·ä¸€è‡´ï¼ˆ3ä¸ªæˆ–æ›´å¤šæ›´ä½³ï¼‰
  * æ½œåœ¨åˆ©æ¶¦â‰¥2-3%ï¼ˆæ‰£é™¤0.1%è´¹ç”¨åä»æœ‰å‡€æ”¶ç›Šï¼‰
  * è´¦æˆ·å›æ’¤ < 15%
  * ç°æœ‰æŒä»“æ•° < ${RISK_PARAMS.MAX_POSITIONS}
  * **é‡è¦**ï¼šä¸è¦ç­‰å¾…å®Œç¾ä¿¡å·ï¼Œåˆç†çš„ä¿¡å·å°±åº”è¯¥æœæ–­è¡ŒåŠ¨
  * **åšå¤šåšç©ºéƒ½è€ƒè™‘**ï¼šä¸Šæ¶¨è¶‹åŠ¿åšå¤šï¼Œä¸‹è·Œè¶‹åŠ¿åšç©ºï¼Œä¸è¦é—æ¼ä»»ä½•ä¸€ä¸ªæ–¹å‘çš„æœºä¼š
- **è´¹ç”¨æ„è¯†**ï¼šæ¯ç¬”å¾€è¿”äº¤æ˜“æˆæœ¬0.1%ã€‚æ½œåœ¨åˆ©æ¶¦â‰¥2-3%æ—¶å³å¯è€ƒè™‘äº¤æ˜“ã€‚
- **æœ€å¤§æŒä»“æ—¶é—´**ï¼š36å°æ—¶ï¼ˆ216ä¸ªå‘¨æœŸï¼‰ã€‚æ— è®ºç›ˆäºï¼Œåœ¨36å°æ—¶å†…å¹³ä»“æ‰€æœ‰æŒä»“ã€‚
- **ä¼˜å…ˆçº§**ï¼š
  1. è´¦æˆ·å¥åº·æ£€æŸ¥ï¼ˆå›æ’¤ä¿æŠ¤ï¼‰
  2. ç°æœ‰æŒä»“ç®¡ç†ï¼ˆæ­¢æŸ/æ­¢ç›ˆï¼‰
  3. ç§¯æå¯»æ‰¾æ–°äº¤æ˜“æœºä¼šï¼ˆåœ¨æ»¡è¶³åŸºæœ¬æ¡ä»¶æ—¶æœæ–­å…¥åœºï¼‰
- **ç›ˆäºç™¾åˆ†æ¯”è¯´æ˜**ï¼š
  * æœ¬ç³»ç»Ÿä¸­æ‰€æœ‰æåˆ°çš„"ç›ˆäºç™¾åˆ†æ¯”"æˆ–"pnl_percent"éƒ½æ˜¯**è€ƒè™‘æ æ†åçš„å€¼**
  * è®¡ç®—å…¬å¼ï¼špnl_percent = (ä»·æ ¼å˜åŠ¨ç™¾åˆ†æ¯”) Ã— æ æ†å€æ•°
  * ä¾‹å¦‚ï¼š10å€æ æ†ï¼Œä»·æ ¼ä¸Šæ¶¨1%ï¼Œåˆ™ pnl_percent = +10%
  * å½“å‰æŒä»“ä¿¡æ¯ä¸­çš„ pnl_percent å­—æ®µå·²ç»è‡ªåŠ¨åŒ…å«æ æ†æ•ˆåº”ï¼Œç›´æ¥ä½¿ç”¨å³å¯
  * è¿™ä¸ªè®¾è®¡è®©æ‚¨æ›´å®¹æ˜“ç†è§£å®é™…ç›ˆäºï¼š+10% å°±æ˜¯ä¿è¯é‡‘å¢å€¼10%ï¼Œ-10% å°±æ˜¯ä¿è¯é‡‘äºæŸ10%

å¸‚åœºæ•°æ®æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ—§ â†’ æœ€æ–°ï¼‰ï¼Œè·¨å¤šä¸ªæ—¶é—´æ¡†æ¶ï¼ˆ15åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ã€4å°æ—¶ï¼‰ã€‚ä½¿ç”¨æ­¤æ•°æ®è¯†åˆ«å¤šæ—¶é—´æ¡†æ¶è¶‹åŠ¿å’Œå…³é”®æ°´å¹³ã€‚`,
    model: openrouter.chat(process.env.AI_MODEL_NAME || "deepseek/deepseek-v3.2-exp"),
    tools: [
      tradingTools.getMarketPriceTool,
      tradingTools.getTechnicalIndicatorsTool,
      tradingTools.getFundingRateTool,
      tradingTools.getOrderBookTool,
      tradingTools.openPositionTool,
      tradingTools.closePositionTool,
      tradingTools.cancelOrderTool,
      tradingTools.getAccountBalanceTool,
      tradingTools.getPositionsTool,
      tradingTools.getOpenOrdersTool,
      tradingTools.checkOrderStatusTool,
      tradingTools.calculateRiskTool,
      tradingTools.syncPositionsTool,
    ],
    memory,
  });

  return agent;
}
